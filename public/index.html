<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MQTT Web Client</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>MQTT Web Client</h1>
            <p class="status">Status : <span id="status">Menghubungkan...</span></p>
        </header>

        <div class="main-content">
            <div class="controls-panel">
                <div class="control-section">
                    <h3>Subscribe Topic</h3>
                    <div class="input-group">
                        <label class="input-label">Topic</label>
                        <input type="text" id="sub-topic" placeholder="Masukkan nama topic untuk subscribe" value="sistercoba">
                    </div>
                    <button onclick="subscribe()">Subscribe</button>
                </div>

                <div class="control-section">
                    <h3>Publish Message</h3>
                    <div class="input-group">
                        <label class="input-label">Topic</label>
                        <input type="text" id="pub-topic" placeholder="Masukkan nama topic untuk publish" value="sistercoba">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Message</label>
                        <input type="text" id="pub-message" placeholder="Masukkan isi pesan yang akan dikirim" value="ok">
                    </div>
                    <button onclick="publish()">Publish</button>
                </div>
            </div>

            <div class="messages-panel">
                <h3>Message :</h3>
                <div id="messages"></div>
            </div>
        </div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        const subTopicEl = document.getElementById('sub-topic');
        const pubTopicEl = document.getElementById('pub-topic');
        const pubMessageEl = document.getElementById('pub-message');

         // Konek ke server client via WebSocket
        const ws = new WebSocket(`ws://${window.location.host}`);

        ws.onopen = () => {
            statusEl.textContent = 'Terhubung';
            statusEl.style.color = '#4CAF50';
        };

        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                
                if (data.type === 'welcome') return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <strong class="topic-name">[${data.topic}]</strong>
                        <small class="timestamp">${data.timestamp || new Date().toLocaleString()}</small>
                    </div>
                    <div class="message-content">${data.message}</div>
                `;
                messagesEl.appendChild(messageDiv);
                messagesEl.scrollTop = messagesEl.scrollHeight;
                
            } catch (e) {
                console.error('Error parsing message:', e);
            }
        };

        ws.onclose = () => {
            statusEl.textContent = 'Terputus';
            statusEl.style.color = '#FF6B9D';
        };

        ws.onerror = () => {
            statusEl.textContent = 'Error!';
            statusEl.style.color = '#FF6B9D';
        };

        // Fungsi untuk button subscribe
        function subscribe() {
            const topic = subTopicEl.value.trim();
            if (!topic) {
                alert('Topic subscribe tidak boleh kosong!');
                return;
            }
            
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    action: 'subscribe',
                    topic: topic
                }));
            } else {
                alert('WebSocket not connected!');
            }
        }
        
        // Fungsi untuk button publish
        function publish() {
            const topic = pubTopicEl.value.trim();
            const message = pubMessageEl.value.trim();
            
            if (!topic || !message) {
                alert('Topic dan Pesan tidak boleh kosong!');
                return;
            }
            
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    action: 'publish',
                    topic: topic,
                    message: message
                }));
            } else {
                alert('WebSocket not connected!');
            }
        }
    </script>
</body>
</html>
